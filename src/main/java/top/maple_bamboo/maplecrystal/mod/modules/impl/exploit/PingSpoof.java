/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  net.minecraft.client.util.math.MatrixStack
 *  net.minecraft.network.listener.PacketListener
 *  net.minecraft.network.packet.Packet
 *  net.minecraft.network.packet.s2c.common.CommonPingS2CPacket
 *  net.minecraft.network.packet.s2c.common.KeepAliveS2CPacket
 */
package top.maple_bamboo.maplecrystal.mod.modules.impl.exploit;

import net.minecraft.client.util.math.MatrixStack;
import net.minecraft.network.listener.PacketListener;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.s2c.common.CommonPingS2CPacket;
import net.minecraft.network.packet.s2c.common.KeepAliveS2CPacket;
import top.maple_bamboo.maplecrystal.api.events.eventbus.EventListener;
import top.maple_bamboo.maplecrystal.api.events.impl.PacketEvent;
import top.maple_bamboo.maplecrystal.api.events.impl.UpdateEvent;
import top.maple_bamboo.maplecrystal.api.utils.Wrapper;
import top.maple_bamboo.maplecrystal.api.utils.math.Timer;
import top.maple_bamboo.maplecrystal.mod.modules.Module;
import top.maple_bamboo.maplecrystal.mod.modules.settings.impl.SliderSetting;

import java.util.concurrent.CopyOnWriteArrayList;

public class PingSpoof
extends Module {
    final CopyOnWriteArrayList<CustomPacket> packet = new CopyOnWriteArrayList();
    private final SliderSetting spoof = this.add(new SliderSetting("Spoof", 500.0, 0.0, 5000.0, 1.0).setSuffix("ms"));

    public PingSpoof() {
        super("PingSpoof", Module.Category.Exploit);
        this.setChinese("\u5ef6\u8fdf\u6b3a\u9a97");
    }

    @Override
    public void onLogout() {
        this.packet.clear();
    }

    @EventListener
    public void onPacketReceive(PacketEvent.Receive event) {
        if (PingSpoof.nullCheck()) {
            return;
        }
        if (event.getPacket() instanceof CommonPingS2CPacket || event.getPacket() instanceof KeepAliveS2CPacket) {
            this.packet.add(new CustomPacket(this, event.getPacket()));
            event.cancel();
        }
    }

    @EventListener
    public void onUpdate(UpdateEvent event) {
        this.update();
    }

    @Override
    public void onRender3D(MatrixStack matrixStack) {
        this.update();
    }

    @Override
    public void onDisable() {
        if (PingSpoof.nullCheck()) {
            this.packet.clear();
            return;
        }
        for (CustomPacket p : this.packet) {
            p.apply();
        }
    }

    private void update() {
        if (PingSpoof.nullCheck()) {
            this.packet.clear();
            return;
        }
        this.packet.removeIf(CustomPacket::send);
    }

    private class CustomPacket {
        final Packet pp;
        final int delay;
        private final Timer timer;

        public CustomPacket(PingSpoof pingSpoof, Packet p) {
            this.pp = p;
            this.timer = new Timer();
            this.delay = pingSpoof.spoof.getValueInt();
        }

        public boolean send() {
            if (this.timer.passed(this.delay)) {
                try {
                    this.apply();
                }
                catch (Exception e) {
                    e.printStackTrace();
                }
                return true;
            }
            return false;
        }

        public void apply() {
            if (this.pp != null) {
                this.pp.apply((PacketListener)Wrapper.mc.getNetworkHandler());
            }
        }
    }
}

